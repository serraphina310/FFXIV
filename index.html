<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 採集原料資料庫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { 
            background-color: #f8f9fa; 
            padding-top: 40px; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
        }
        
        /* 標題區塊 */
        .header-box { text-align: center; margin-bottom: 30px; }
        .header-box h1 { color: #333; font-weight: 800; letter-spacing: 1px; }

        /* 搜尋區塊 */
        .search-card {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border-top: 5px solid #0d6efd;
        }

        /* 今日清單區塊 (新功能) */
        .todo-card {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border-left: 5px solid #198754; /* 綠色邊框區分 */
        }
        .todo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        /* 圖片樣式 */
        .item-img { 
            width: 48px; height: 48px; 
            border-radius: 6px; 
            object-fit: cover; 
            border: 1px solid #dee2e6; 
            background-color: #f8f9fa; 
        }
        
        /* 狀態訊息 */
        .status-msg { text-align: center; color: #666; margin-top: 20px; font-size: 1.1em; }
        
        /* 表格樣式 */
        .table-hover tbody tr:hover { background-color: #f1f3f5; }
        .badge-map { 
            font-size: 0.9em; font-weight: normal; 
            background-color: #e7f1ff; color: #0d6efd; 
            border: 1px solid #cce5ff; 
        }

        /* 數量輸入框 */
        .qty-input { width: 80px; text-align: center; }
    </style>
</head>
<body>

<div class="container pb-5">
    
    <div class="header-box">
        <h1><i class="bi bi-database-fill"></i> FF14 採集原料資料庫</h1>
        <p class="text-muted">查詢並建立今日採集清單</p>
    </div>

    <div class="search-card">
        <label for="searchInput" class="form-label fw-bold text-dark mb-3">
            <i class="bi bi-search"></i> 請輸入原料名稱：
        </label>
        
        <div class="input-group input-group-lg mb-3">
            <input type="text" id="searchInput" class="form-control" 
                placeholder="例如：鐵礦 (請輸入完整名稱)" 
                onkeypress="handleEnter(event)">
            <button class="btn btn-primary" onclick="searchDB()">
                <i class="bi bi-search"></i> 搜尋
            </button>
        </div>

        <div class="d-flex justify-content-center">
            <button class="btn btn-outline-success btn-sm" onclick="searchWiki()">
                <i class="bi bi-globe2"></i> 搜 灰機Wiki
            </button>
        </div>
        
        <div class="text-center mt-2">
            <small class="text-muted">提示：本資料庫使用精準搜尋 (輸入「鐵礦」不會顯示「玄鐵礦」)</small>
        </div>
    </div>

    <div id="todoSection" class="todo-card d-none">
        <div class="todo-header">
            <h4 class="m-0 text-success"><i class="bi bi-clipboard-check-fill"></i> 今日採集清單</h4>
            <button class="btn btn-sm btn-outline-danger" onclick="clearTodoList()">
                <i class="bi bi-trash-fill"></i> 清空清單
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
                <thead class="table-success">
                    <tr>
                        <th width="30%">名稱</th>
                        <th width="30%">地點</th>
                        <th width="20%">數量</th>
                        <th width="20%">操作</th>
                    </tr>
                </thead>
                <tbody id="todoBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="table-responsive bg-white shadow-sm p-3 rounded d-none" id="resultContainer">
        <h5 class="mb-3 text-primary"><i class="bi bi-list-ul"></i> 搜尋結果</h5>
        <table class="table table-hover align-middle mb-0">
            <thead class="table-primary">
                <tr>
                    <th width="60" class="text-center">圖片</th>
                    <th width="20%">原料名稱</th>
                    <th width="20%">地圖</th>
                    <th width="25%">座標</th>
                    <th width="15%">功能</th> </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <div id="statusMsg" class="status-msg">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">正在同步 Google Sheets 資料庫...</p>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= 設定區 =================
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKLU1K1ol-mP7n2gz7clz522QmjoTAMRfz1lxSKjBwTPMvC5eMimPycZ-RsknpuYkUPaWmHWqj-QNe/pub?output=csv'; 
    // ==========================================

    let allData = []; // 完整資料庫
    let isDataLoaded = false;
    let todoList = []; // 今日清單資料 [ {name, map, loc, count, img} ]

    // 頁面載入後自動執行
    document.addEventListener('DOMContentLoaded', loadData);

    // --- 1. 背景讀取資料 ---
    function loadData() {
        Papa.parse(SHEET_CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                allData = results.data.filter(row => row['原料名稱'] && row['原料名稱'].trim() !== '');
                isDataLoaded = true;
                
                const msg = document.getElementById('statusMsg');
                msg.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> 資料庫已就緒。';
                setTimeout(() => { msg.style.display = 'none'; }, 2000);
            },
            error: function(err) {
                console.error(err);
                document.getElementById('statusMsg').innerHTML = 
                    `<span class="text-danger">讀取失敗，請檢查網路。<br>${err.message}</span>`;
            }
        });
    }

    // --- 2. 搜尋功能 (精準比對) ---
    // 為了讓按鈕能抓到資料，我們使用一個全域變數暫存當前搜尋結果
    let currentSearchResults = [];

    function searchDB() {
        if (!isDataLoaded) { alert("資料庫讀取中..."); return; }

        const input = document.getElementById('searchInput').value.trim();
        const resultContainer = document.getElementById('resultContainer');
        const statusMsg = document.getElementById('statusMsg');
        const tbody = document.getElementById('tableBody');

        tbody.innerHTML = '';
        statusMsg.style.display = 'block';

        if (input === "") {
            statusMsg.innerHTML = "請輸入關鍵字。";
            resultContainer.classList.add('d-none');
            return;
        }

        // 精準比對
        currentSearchResults = allData.filter(row => {
            return row['原料名稱'] && row['原料名稱'].trim() === input; 
        });

        if (currentSearchResults.length === 0) {
            statusMsg.innerHTML = `<span class="text-muted">找不到「<strong>${input}</strong>」。<br>請確認名稱完全正確。</span>`;
            resultContainer.classList.add('d-none');
        } else {
            statusMsg.style.display = 'none';
            resultContainer.classList.remove('d-none');
            renderResultTable(currentSearchResults);
        }
    }

    function renderResultTable(data) {
        const tbody = document.getElementById('tableBody');
        
        data.forEach((row, index) => {
            // 處理圖片
            let imgDisplay = '<i class="bi bi-image text-muted" style="font-size: 24px;"></i>';
            let link = row['圖片連結'] ? row['圖片連結'].replace(/'/g, "").trim() : "";
            if(link.startsWith('http')) {
                imgDisplay = `<img src="${link}" class="item-img" onerror="this.style.display='none'">`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">${imgDisplay}</td>
                <td class="fw-bold text-primary">${row['原料名稱']}</td>
                <td>${row['地圖編號'] || '-'}</td>
                <td class="font-monospace">${row['採集地點'] || '-'}</td>
                <td>
                    <button class="btn btn-outline-success btn-sm" onclick="addToTodoList(${index})">
                        <i class="bi bi-plus-lg"></i> 加入
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 3. 今日清單功能 ---
    
    // 加入清單
    function addToTodoList(index) {
        const item = currentSearchResults[index];
        if(!item) return;

        const name = item['原料名稱'];
        
        // 檢查是否已存在
        const existingItem = todoList.find(i => i.name === name);
        
        if (existingItem) {
            existingItem.count++; // 存在則數量+1
        } else {
            // 不存在則新增
            todoList.push({
                name: item['原料名稱'],
                map: item['地圖編號'] || '-',
                loc: item['採集地點'] || '-',
                count: 1
            });
        }
        
        renderTodoList();
    }

    // 渲染清單
    function renderTodoList() {
        const section = document.getElementById('todoSection');
        const tbody = document.getElementById('todoBody');
        tbody.innerHTML = '';

        if (todoList.length === 0) {
            section.classList.add('d-none'); // 沒資料隱藏區塊
            return;
        }

        section.classList.remove('d-none'); // 有資料顯示區塊

        todoList.forEach((item, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="fw-bold">${item.name}</td>
                <td class="small text-muted">${item.map} <br> ${item.loc}</td>
                <td>
                    <input type="number" class="form-control form-control-sm qty-input" 
                        value="${item.count}" min="1" 
                        onchange="updateListCount(${idx}, this.value)">
                </td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="removeTodoItem(${idx})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 更新數量
    function updateListCount(idx, val) {
        if(val < 1) val = 1;
        todoList[idx].count = parseInt(val);
    }

    // 刪除單項
    function removeTodoItem(idx) {
        todoList.splice(idx, 1);
        renderTodoList();
    }

    // 清空全部
    function clearTodoList() {
        if(confirm("確定要清空今日清單嗎？")) {
            todoList = [];
            renderTodoList();
        }
    }

    // --- 4. 外部連結 ---
    function searchWiki() {
        const input = document.getElementById('searchInput').value.trim();
        if (!input) { alert("請先輸入原料名稱！"); return; }
        
        const url = `https://www.google.com/search?q=site%3Aff14.huijiwiki.com+${encodeURIComponent(input)}`;
        window.open(url, '_blank');
    }

    function handleEnter(e) {
        if (e.key === 'Enter') searchDB();
    }
</script>

</body>
</html>
