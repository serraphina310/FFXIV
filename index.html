<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 採集原料資料庫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { 
            background-color: #f8f9fa; 
            padding-top: 40px; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
        }
        
        /* 標題區塊 */
        .header-box { text-align: center; margin-bottom: 40px; }
        .header-box h1 { color: #333; font-weight: 800; letter-spacing: 1px; }

        /* 搜尋區塊主體 */
        .search-card {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border-top: 5px solid #0d6efd;
        }

        /* 圖片樣式 */
        .item-img { 
            width: 48px; height: 48px; 
            border-radius: 6px; 
            object-fit: cover; 
            border: 1px solid #dee2e6; 
            background-color: #f8f9fa; 
        }
        
        /* 狀態訊息 */
        .status-msg { text-align: center; color: #666; margin-top: 20px; font-size: 1.1em; }
        
        /* 表格樣式 */
        .table-hover tbody tr:hover { background-color: #f1f3f5; }
        .badge-map { 
            font-size: 0.9em; font-weight: normal; 
            background-color: #e7f1ff; color: #0d6efd; 
            border: 1px solid #cce5ff; 
        }

        /* 搜尋按鈕群組微調 */
        .btn-group-custom .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div class="container pb-5">
    
    <div class="header-box">
        <h1><i class="bi bi-database-fill"></i> FF14 採集原料資料庫</h1>
        <p class="text-muted">快速查詢採集地點與座標</p>
    </div>

    <div class="search-card">
        <label for="searchInput" class="form-label fw-bold text-dark mb-3">
            <i class="bi bi-search"></i> 請輸入原料名稱：
        </label>
        
        <div class="input-group input-group-lg mb-3">
            <input type="text" id="searchInput" class="form-control" 
                placeholder="例如：鐵礦 (請輸入完整名稱)" 
                onkeypress="handleEnter(event)">
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-center">
            <button class="btn btn-primary px-4 py-2" onclick="searchDB()">
                <i class="bi bi-server"></i> 查詢本資料庫
            </button>
            
            <button class="btn btn-outline-success px-3 py-2" onclick="searchExternal('wiki')">
                <i class="bi bi-globe2"></i> 搜 灰機Wiki
            </button>
            <button class="btn btn-outline-secondary px-3 py-2" onclick="searchExternal('teamcraft')">
                <img src="https://ffxivteamcraft.com/assets/logo.png" width="20" style="vertical-align:text-bottom"> 搜 Teamcraft
            </button>
        </div>
        
        <div class="text-center mt-2">
            <small class="text-muted">提示：本資料庫使用精準搜尋，請輸入完整物品名稱 (例如輸入「鐵礦」不會顯示「玄鐵礦」)</small>
        </div>
    </div>

    <div class="table-responsive bg-white shadow-sm p-3 rounded d-none" id="resultContainer">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-primary">
                <tr>
                    <th width="80" class="text-center">圖片</th>
                    <th width="20%">原料名稱</th>
                    <th width="20%">地圖</th>
                    <th width="25%">採集地點 (座標)</th>
                    <th>備註</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <div id="statusMsg" class="status-msg">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">正在同步 Google Sheets 資料庫...</p>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= 設定區 =================
    // 您的 Google Sheet CSV 連結
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKLU1K1ol-mP7n2gz7clz522QmjoTAMRfz1lxSKjBwTPMvC5eMimPycZ-RsknpuYkUPaWmHWqj-QNe/pub?output=csv'; 
    // ==========================================

    let allData = []; // 存放下載後的完整資料
    let isDataLoaded = false;

    // 頁面載入後自動執行
    document.addEventListener('DOMContentLoaded', loadData);

    // --- 1. 背景讀取資料 ---
    function loadData() {
        Papa.parse(SHEET_CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                // 過濾掉空行
                allData = results.data.filter(row => row['原料名稱'] && row['原料名稱'].trim() !== '');
                isDataLoaded = true;
                
                // 資料讀取完畢，隱藏載入動畫，顯示準備就緒
                const msg = document.getElementById('statusMsg');
                msg.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> 資料庫已就緒，請輸入關鍵字搜尋。';
                setTimeout(() => { msg.style.display = 'none'; }, 2000); // 2秒後隱藏提示
            },
            error: function(err) {
                console.error(err);
                document.getElementById('statusMsg').innerHTML = 
                    `<span class="text-danger">讀取失敗，請檢查網路。<br>${err.message}</span>`;
            }
        });
    }

    // --- 2. 搜尋本資料庫 (精準比對) ---
    function searchDB() {
        if (!isDataLoaded) {
            alert("資料庫正在讀取中，請稍候...");
            return;
        }

        const input = document.getElementById('searchInput').value.trim();
        const resultContainer = document.getElementById('resultContainer');
        const statusMsg = document.getElementById('statusMsg');
        const tbody = document.getElementById('tableBody');

        // 清空舊結果
        tbody.innerHTML = '';
        statusMsg.style.display = 'block'; // 暫時顯示狀態區

        if (input === "") {
            statusMsg.innerHTML = "請輸入關鍵字。";
            resultContainer.classList.add('d-none');
            return;
        }

        // --- 核心邏輯：精準比對 ---
        // 條件：原料名稱 "完全等於" 輸入的關鍵字 (忽略前後空白)
        const results = allData.filter(row => {
            const itemName = row['原料名稱'] ? row['原料名稱'].trim() : "";
            return itemName === input; 
        });

        if (results.length === 0) {
            statusMsg.innerHTML = `<span class="text-muted">找不到與「<strong>${input}</strong>」完全相符的資料。<br>請確認名稱是否正確，或嘗試使用外部搜尋。</span>`;
            resultContainer.classList.add('d-none');
        } else {
            statusMsg.style.display = 'none'; // 有資料則隱藏狀態訊息
            resultContainer.classList.remove('d-none'); // 顯示表格
            renderTable(results);
        }
    }

    // --- 3. 渲染表格 ---
    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        
        // 為了美觀，將資料反轉 (如果 CSV 是舊->新，這裡反轉可能不是必須，視您喜好)
        // 這裡暫時保持原序，或者您想看最新的資料可以用 .reverse()
        
        data.forEach(row => {
            // 處理圖片
            let imgDisplay = '<i class="bi bi-image text-muted" style="font-size: 24px;"></i>';
            let link = row['圖片連結'] ? row['圖片連結'].replace(/'/g, "").trim() : "";
            
            if(link.startsWith('http')) {
                imgDisplay = `<img src="${link}" class="item-img" alt="圖" onerror="this.style.display='none'">`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">${imgDisplay}</td>
                <td class="fw-bold text-primary" style="font-size: 1.1em;">${row['原料名稱']}</td>
                <td>${row['地圖編號'] ? `<span class="badge badge-map p-2">${row['地圖編號']}</span>` : '-'}</td>
                <td class="font-monospace">${row['採集地點'] || '-'}</td>
                <td class="text-muted small">${row['備註'] || ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 4. 外部搜尋功能 ---
    function searchExternal(site) {
        const input = document.getElementById('searchInput').value.trim();
        if (!input) {
            alert("請先輸入原料名稱！");
            return;
        }

        let url = '';
        if (site === 'wiki') {
            url = `https://www.google.com/search?q=site%3Aff14.huijiwiki.com+${encodeURIComponent(input)}`;
        } else if (site === 'teamcraft') {
            url = `https://ffxivteamcraft.com/search?query=${encodeURIComponent(input)}`;
        }
        
        window.open(url, '_blank');
    }

    // 綁定 Enter 鍵觸發資料庫搜尋
    function handleEnter(e) {
        if (e.key === 'Enter') searchDB();
    }
</script>

</body>
</html>
