<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 æ¡é›†åŸæ–™è³‡æ–™åº«</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* å€å¡Šæ¨£å¼ */
        .section-box { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .wiki-search-box { background: #e9ecef; border-left: 5px solid #0d6efd; }
        
        /* åœ–ç‰‡æ¨£å¼ */
        .item-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid #ddd; }
        
        .loading { text-align: center; color: #666; margin-top: 20px; }
        h1 { color: #333; font-weight: 800; letter-spacing: 1px; }

        /* æœå°‹æ¡†ç¾åŒ– */
        #dbInput { border: 2px solid #0d6efd; background-color: #fff; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        
        /* æ‡¸æµ®æŒ‰éˆ•æ¨£å¼ */
        .btn-float { 
            position: fixed; bottom: 30px; right: 30px; 
            border-radius: 50%; width: 60px; height: 60px; 
            font-size: 24px; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4); 
            z-index: 1000; transition: transform 0.2s;
        }
        .btn-float:hover { transform: scale(1.1); }
        
        /* æ¡é›†æ¸…å–®æ¨£å¼ */
        .todo-done { background-color: #f0f0f0; color: #999; }
        .todo-done td { text-decoration: line-through; }
        .todo-done input { text-decoration: none; color: #999; }

        .modal-header { background-color: #0d6efd; color: white; }
    </style>
</head>
<body>

<div class="container pb-5">
    <div class="text-center mb-4">
        <h1><i class="bi bi-database-fill-gear"></i> FF14 æ¡é›†åŸæ–™è³‡æ–™åº«</h1>
        <p class="text-muted">å³æ™‚æŸ¥è©¢èˆ‡å›å ±æ¡é›†åœ°é»</p>
    </div>

    <div class="section-box wiki-search-box">
        <h5><i class="bi bi-search"></i> æœå°‹ FF14 ç°æ©Ÿ Wiki</h5>
        <div class="input-group">
            <input type="text" id="wikiInput" class="form-control" placeholder="è¼¸å…¥é—œéµå­— (ä¾‹å¦‚: éˆéŠ€ç¤¦)...">
            <button class="btn btn-secondary" onclick="searchWiki()">æœå°‹ Wiki</button>
        </div>
    </div>

    <div class="section-box">
        <label for="dbInput" class="form-label fw-bold text-primary">
            <i class="bi bi-funnel-fill"></i> æœå°‹è³‡æ–™åº« (æ”¯æ´å¤šé—œéµå­—)ï¼š
        </label>
        <div class="alert alert-info py-2 mb-2">
            <small><i class="bi bi-info-circle"></i> æç¤ºï¼šåŸæ–™åç¨±ç‚ºã€Œå®Œå…¨ç¬¦åˆã€ï¼Œåœ°åœ–èˆ‡å‚™è¨»ç‚ºã€Œéƒ¨åˆ†ç¬¦åˆã€ã€‚å¤šå€‹é—œéµå­—è«‹ç”¨ç©ºç™½æˆ–æ›è¡Œåˆ†éš”ã€‚</small>
        </div>
        <textarea id="dbInput" class="form-control mb-3" rows="5" 
            placeholder="åœ¨æ­¤è¼¸å…¥é—œéµå­—ï¼Œä¾‹å¦‚ï¼š&#10;éµç¤¦&#10;éˆéŠ€ç¤¦&#10;(æ”¯æ´ä¸€æ¬¡æœå°‹å¤šé …ç‰©å“)" 
            onkeyup="handleSearch()"></textarea>
        
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="handleSearch()">
                <i class="bi bi-arrow-repeat"></i> é‡æ–°æœå°‹
            </button>
            <button id="addAllBtn" class="btn btn-success d-none" onclick="addAllVisibleToCart()">
                <i class="bi bi-cart-plus-fill"></i> å°‡æœå°‹çµæœå…¨éƒ¨åŠ å…¥æ¸…å–®
            </button>
        </div>
    </div>

    <div class="section-box border border-warning" id="shoppingListSection">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-warning-emphasis mb-0"><i class="bi bi-clipboard-check-fill"></i> ä»Šæ—¥æ¡é›†æ¸…å–®</h5>
            <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">
                <i class="bi bi-trash"></i> æ¸…ç©ºæ¸…å–®
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="5%" class="text-center"><i class="bi bi-check2-square"></i></th>
                        <th width="30%">åŸæ–™åç¨±</th>
                        <th width="35%">åœ°é»è³‡è¨Š</th>
                        <th width="20%">æ•¸é‡</th>
                        <th width="10%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="cartBody">
                    <tr><td colspan="5" class="text-center text-muted py-3">æ¸…å–®ç›®å‰æ˜¯ç©ºçš„ï¼Œè«‹å¾ä¸‹æ–¹æœå°‹ä¸¦åŠ å…¥åŸæ–™ã€‚</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="section-box p-0 overflow-hidden">
        <div id="loadingMsg" class="loading p-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">æ­£åœ¨å¾ Google Sheets è®€å–è³‡æ–™...</p>
        </div>

        <div id="resultContainer" class="d-none">
            <div class="bg-primary text-white p-2 px-3 fw-bold">
                <i class="bi bi-list-ul"></i> æœå°‹çµæœ
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="10%">åœ–ç‰‡</th>
                            <th width="20%">åŸæ–™åç¨±</th>
                            <th width="20%">åœ°åœ–</th>
                            <th width="20%">åº§æ¨™/å‚™è¨»</th>
                            <th width="10%">åŠŸèƒ½</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                        </tbody>
                </table>
            </div>
            <div id="noResultMsg" class="text-center p-4 text-muted d-none">
                æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„è³‡æ–™ã€‚<br>å¦‚æœæ˜¯åŸæ–™åç¨±ï¼Œè«‹ç¢ºèªè¼¸å…¥å®Œæ•´å…¨å (ä¾‹å¦‚ï¼šè¼¸å…¥ã€Œéµç¤¦ã€è€Œéã€Œéµã€)ã€‚
            </div>
            <div id="startMsg" class="text-center p-4 text-muted">
                è«‹åœ¨ä¸Šæ–¹è¼¸å…¥é—œéµå­—ä»¥é–‹å§‹æœå°‹ã€‚
            </div>
        </div>
    </div>
</div>

<button class="btn btn-primary btn-float" data-bs-toggle="modal" data-bs-target="#addModal" title="æ–°å¢è³‡æ–™">
    <i class="bi bi-plus-lg"></i>
</button>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pen-fill"></i> æ–°å¢æ¡é›†è³‡è¨Š</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm" onsubmit="submitData(event)">
                    <div class="mb-3">
                        <label class="form-label">åŸæ–™åç¨± <span class="text-danger">*</span></label>
                        <input type="text" name="itemName" class="form-control" required placeholder="ä¾‹å¦‚ï¼šéˆéŠ€ç¤¦">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åœ°åœ–ç·¨è™Ÿ</label>
                        <input type="text" name="mapId" class="form-control" placeholder="ä¾‹å¦‚ï¼šLakeland">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ¡é›†åœ°é» (åº§æ¨™)</label>
                        <input type="text" name="loc" class="form-control" placeholder="ä¾‹å¦‚ï¼šX:10.5 Y:20.1">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">åœ–ç‰‡é€£çµ (é¸å¡«)</label>
                        <input type="text" name="imgLink" class="form-control" placeholder="è«‹è²¼ä¸Šåœ–ç‰‡ç¶²å€ (https://...)">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">å‚™è¨»</label>
                        <textarea name="note" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="d-grid">
                        <button type="submit" id="submitBtn" class="btn btn-primary">é€å‡ºè³‡æ–™</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= è¨­å®šå€ =================
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKLU1K1ol-mP7n2gz7clz522QmjoTAMRfz1lxSKjBwTPMvC5eMimPycZ-RsknpuYkUPaWmHWqj-QNe/pub?output=csv'; 
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdE3CRPxQkwhd9-RW644BY6oCZUPyrenHAV0UlqfBapt543okqNREiCMmTKW31A9h-Sg/exec';
    // ==========================================

    let allData = [];         
    let currentResults = [];  
    let shoppingList = [];    

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        loadCartFromStorage(); 
    });

    // --- 1. è³‡æ–™è®€å– ---
    function loadData() {
        Papa.parse(SHEET_CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                allData = results.data.filter(row => row['åŸæ–™åç¨±'] && row['åŸæ–™åç¨±'].trim() !== '').reverse();
                document.getElementById('loadingMsg').style.display = 'none';
                document.getElementById('resultContainer').classList.remove('d-none');
            },
            error: function(err) {
                console.error(err);
                document.getElementById('loadingMsg').innerHTML = 
                    `<span class="text-danger">è®€å–å¤±æ•—ã€‚<br>${err.message}</span>`;
            }
        });
    }

    // --- 2. æœå°‹é‚è¼¯ (æ ¸å¿ƒä¿®æ”¹è™•) ---
    function handleSearch() {
        const input = document.getElementById('dbInput').value.trim().toUpperCase();
        const resultBody = document.getElementById('resultBody');
        const startMsg = document.getElementById('startMsg');
        const noResultMsg = document.getElementById('noResultMsg');
        const addAllBtn = document.getElementById('addAllBtn');

        resultBody.innerHTML = '';
        currentResults = [];

        if (!input) {
            startMsg.classList.remove('d-none');
            noResultMsg.classList.add('d-none');
            addAllBtn.classList.add('d-none');
            return;
        }

        startMsg.classList.add('d-none');

        // åˆ†å‰²é—œéµå­—
        const keywords = input.split(/[\s,]+/).filter(k => k);

        // ç¯©é¸è³‡æ–™
        currentResults = allData.filter(row => {
            // ä¿®æ­£é‚è¼¯ï¼š
            // 1. ä½¿ç”¨ some (OR é‚è¼¯)ï¼Œåªè¦ç¬¦åˆå…¶ä¸­ä¸€å€‹é—œéµå­—å°±é¡¯ç¤ºï¼Œè§£æ±ºå¤šé—œéµå­—æ²’è³‡æ–™å•é¡Œ
            // 2. åŸæ–™åç¨±ä½¿ç”¨ === (å®Œå…¨ç¬¦åˆ)ï¼Œè§£æ±ºã€Œéµç¤¦ã€é¡¯ç¤ºã€Œç„éµç¤¦ã€å•é¡Œ
            // 3. åœ°åœ–/å‚™è¨»ä½¿ç”¨ includes (éƒ¨åˆ†ç¬¦åˆ)ï¼Œä¿æŒæœå°‹åœ°åœ–çš„å½ˆæ€§
            
            const name = row['åŸæ–™åç¨±'] ? row['åŸæ–™åç¨±'].toUpperCase().trim() : '';
            const mapId = row['åœ°åœ–ç·¨è™Ÿ'] ? row['åœ°åœ–ç·¨è™Ÿ'].toUpperCase() : '';
            const loc = row['æ¡é›†åœ°é»'] ? row['æ¡é›†åœ°é»'].toUpperCase() : '';
            const note = row['å‚™è¨»'] ? row['å‚™è¨»'].toUpperCase() : '';

            return keywords.some(k => {
                // åŸæ–™åç¨±ï¼šå¿…é ˆå®Œå…¨ç›¸ç­‰
                const isNameMatch = (name === k);
                // å…¶ä»–æ¬„ä½ï¼šåŒ…å«å³å¯
                const isMapMatch = mapId.includes(k);
                const isLocMatch = loc.includes(k);
                const isNoteMatch = note.includes(k);

                return isNameMatch || isMapMatch || isLocMatch || isNoteMatch;
            });
        });

        if (currentResults.length === 0) {
            noResultMsg.classList.remove('d-none');
            addAllBtn.classList.add('d-none');
        } else {
            noResultMsg.classList.add('d-none');
            addAllBtn.classList.remove('d-none');
            renderResults(currentResults);
        }
    }

    // æ¸²æŸ“æœå°‹çµæœ
    function renderResults(data) {
        const tbody = document.getElementById('resultBody');
        
        data.forEach((row, index) => {
            let imgDisplay = '<span class="text-muted">-</span>';
            let link = row['åœ–ç‰‡é€£çµ'] ? row['åœ–ç‰‡é€£çµ'].replace(/'/g, "").trim() : "";
            if(link.startsWith('http')) {
                imgDisplay = `<img src="${link}" class="item-img" alt="åœ–">`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${imgDisplay}</td>
                <td class="fw-bold text-primary">${row['åŸæ–™åç¨±']}</td>
                <td>${row['åœ°åœ–ç·¨è™Ÿ'] || ''}</td>
                <td>
                    <div>${row['æ¡é›†åœ°é»'] || ''}</div>
                    <small class="text-muted">${row['å‚™è¨»'] || ''}</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-success" onclick="addToCartByRow(${index})">
                        <i class="bi bi-plus-lg"></i> åŠ å…¥
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 3. æ¡é›†æ¸…å–®é‚è¼¯ ---

    function addToCartByRow(index) {
        const item = currentResults[index];
        addToCart(item);
    }

    function addToCart(item) {
        const exists = shoppingList.find(i => i.name === item['åŸæ–™åç¨±'] && i.map === item['åœ°åœ–ç·¨è™Ÿ']);
        if (!exists) {
            shoppingList.push({
                name: item['åŸæ–™åç¨±'],
                map: item['åœ°åœ–ç·¨è™Ÿ'],
                loc: item['æ¡é›†åœ°é»'],
                note: item['å‚™è¨»'],
                qty: 1,
                checked: false
            });
            renderCart();
        }
    }

    function addAllVisibleToCart() {
        if(currentResults.length > 50) {
            if(!confirm(`ç¢ºå®šè¦ä¸€æ¬¡åŠ å…¥ ${currentResults.length} ç­†è³‡æ–™å—ï¼Ÿ`)) return;
        }
        
        let count = 0;
        currentResults.forEach(item => {
            const exists = shoppingList.find(i => i.name === item['åŸæ–™åç¨±'] && i.map === item['åœ°åœ–ç·¨è™Ÿ']);
            if(!exists) {
                shoppingList.push({
                    name: item['åŸæ–™åç¨±'],
                    map: item['åœ°åœ–ç·¨è™Ÿ'],
                    loc: item['æ¡é›†åœ°é»'],
                    note: item['å‚™è¨»'],
                    qty: 1,
                    checked: false
                });
                count++;
            }
        });
        renderCart();
        alert(`å·²åŠ å…¥ ${count} ç­†æ–°è³‡æ–™åˆ°æ¸…å–®ã€‚`);
    }

    function renderCart() {
        const tbody = document.getElementById('cartBody');
        tbody.innerHTML = '';

        if (shoppingList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">æ¸…å–®ç›®å‰æ˜¯ç©ºçš„ï¼Œè«‹å¾ä¸‹æ–¹æœå°‹ä¸¦åŠ å…¥åŸæ–™ã€‚</td></tr>';
            saveCartToStorage();
            return;
        }

        shoppingList.forEach((item, index) => {
            const tr = document.createElement('tr');
            if (item.checked) tr.classList.add('todo-done');

            tr.innerHTML = `
                <td class="text-center">
                    <input class="form-check-input" type="checkbox" 
                        ${item.checked ? 'checked' : ''} 
                        onchange="toggleCartItem(${index})">
                </td>
                <td class="fw-bold">${item.name}</td>
                <td>
                    <span class="badge bg-secondary">${item.map || 'æœªçŸ¥'}</span> 
                    ${item.loc || ''}
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" style="width: 80px" 
                        value="${item.qty}" min="1" 
                        onchange="updateCartQty(${index}, this.value)">
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeCartItem(${index})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        saveCartToStorage();
    }

    function toggleCartItem(index) {
        shoppingList[index].checked = !shoppingList[index].checked;
        renderCart();
    }

    function updateCartQty(index, val) {
        shoppingList[index].qty = val;
        saveCartToStorage();
    }

    function removeCartItem(index) {
        shoppingList.splice(index, 1);
        renderCart();
    }

    function clearCart() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ¸…å–®å—ï¼Ÿ")) {
            shoppingList = [];
            renderCart();
        }
    }

    function saveCartToStorage() {
        localStorage.setItem('ff14_gathering_list', JSON.stringify(shoppingList));
    }
    function loadCartFromStorage() {
        const saved = localStorage.getItem('ff14_gathering_list');
        if (saved) {
            shoppingList = JSON.parse(saved);
            renderCart();
        }
    }

    // --- 4. å…¶ä»–åŠŸèƒ½ ---
    function searchWiki() {
        const query = document.getElementById('wikiInput').value;
        if (query) {
            const url = `https://www.google.com/search?q=site%3Aff14.huijiwiki.com+${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        }
    }
    document.getElementById('wikiInput').addEventListener("keypress", function(event) {
        if (event.key === "Enter") searchWiki();
    });

    function submitData(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨å¯«å…¥...";

        const form = document.getElementById('addForm');
        const formData = new FormData(form);

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.result === 'success') {
                alert('ğŸ‰ æ–°å¢æˆåŠŸï¼\nè³‡æ–™å·²å¯«å…¥ Google Sheetã€‚');
                form.reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
                modal.hide();
            } else {
                alert('âŒ å¯«å…¥å¤±æ•—ï¼š\n' + data.error);
            }
        })
        .catch(err => {
            alert('âŒ é€£ç·šéŒ¯èª¤ï¼š\n' + err);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }
</script>

</body>
</html>
