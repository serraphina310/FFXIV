<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 採集原料資料庫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* 區塊樣式 */
        .section-box { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .wiki-search-box { background: #e9ecef; border-left: 5px solid #0d6efd; }
        
        /* 圖片與載入 */
        .item-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid #ddd; }
        .loading { text-align: center; color: #666; margin-top: 20px; }
        h1 { color: #333; font-weight: 800; letter-spacing: 1px; }
        
        /* 搜尋框優化 */
        #dbInput { border: 2px solid #0d6efd; background-color: #fff; resize: vertical; }
        
        /* 已完成項目樣式 (清單) */
        .row-checked { 
            background-color: #e2e3e5 !important; 
            color: #adb5bd; 
            text-decoration: line-through; 
        }
        .row-checked img { opacity: 0.5; grayscale: 100%; }

        /* 查無資料的行樣式 */
        .row-not-found {
            background-color: #fff5f5;
            color: #999;
            font-style: italic;
        }
        
        /* 表格微調 */
        .table td { vertical-align: middle; }
    </style>
</head>
<body>

<div class="container pb-5">
    <div class="text-center mb-4">
        <h1><i class="bi bi-database-fill-gear"></i> FF14 採集原料資料庫</h1>
        <p class="text-muted">搜尋、規劃與管理您的採集路線</p>
    </div>

    <div class="section-box wiki-search-box">
        <h5><i class="bi bi-search"></i> 搜尋 FF14 灰機 Wiki</h5>
        <div class="input-group">
            <input type="text" id="wikiInput" class="form-control" placeholder="輸入關鍵字 (例如: 靈銀礦)...">
            <button class="btn btn-secondary" onclick="searchWiki()">搜尋 Wiki</button>
        </div>
        <small class="text-muted">將開啟新分頁透過 Google 搜尋 ff14.huijiwiki.com</small>
    </div>

    <hr>

    <div class="mb-4">
        <label for="dbInput" class="form-label fw-bold text-primary h5">
            <i class="bi bi-funnel-fill"></i> 搜尋資料庫 (支援多行/多關鍵字)：
        </label>
        <textarea id="dbInput" class="form-control" rows="5" 
            placeholder="在此輸入關鍵字，例如：&#10;鐵礦&#10;靈銀礦&#10;Lakeland&#10;(支援換行或空白分隔)" 
            onkeyup="filterTable()"></textarea>
        <div class="mt-2 d-flex justify-content-between align-items-center">
            <small class="text-muted">提示：原料名稱需「完全符合」才會顯示；地圖或備註可「部分符合」。</small>
            <button class="btn btn-outline-primary btn-sm" id="addAllBtn" onclick="addAllSearchResults()" style="display: none;">
                <i class="bi bi-check-all"></i> 將搜尋結果全部加入清單
            </button>
        </div>
    </div>

    <div class="table-responsive bg-white shadow-sm p-3 rounded mb-5" id="searchResultSection" style="display: none;">
        <h5 class="text-primary mb-3"><i class="bi bi-list-ul"></i> 搜尋結果</h5>
        
        <div id="loadingMsg" class="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">正在從 Google Sheets 讀取資料...</p>
        </div>

        <table class="table table-hover align-middle mb-0" id="dataTable">
            <thead class="table-primary">
                <tr>
                    <th width="10%">加入</th>
                    <th width="10%">圖片</th>
                    <th width="20%">原料名稱 / 關鍵字</th>
                    <th width="15%">地圖編號</th>
                    <th width="20%">採集地點</th>
                    <th width="25%">備註</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
        <div id="noResultMsg" class="text-center text-muted p-3" style="display: none;">沒有符合的結果</div>
    </div>

    <div class="section-box border border-success border-2">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-success m-0"><i class="bi bi-cart-check-fill"></i> 今日採集清單</h4>
            <button class="btn btn-outline-danger btn-sm" onclick="clearCart()">
                <i class="bi bi-trash"></i> 全部清空
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered align-middle" id="cartTable">
                <thead class="table-success">
                    <tr>
                        <th width="5%" class="text-center">完成</th>
                        <th width="25%">原料名稱</th>
                        <th width="15%">地圖編號</th>
                        <th width="20%">地點/備註</th>
                        <th width="15%">數量</th>
                        <th width="10%">操作</th>
                    </tr>
                </thead>
                <tbody id="cartBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">清單目前是空的，請從上方搜尋並加入項目。</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= 設定區 =================
    // 你的 Google Sheet CSV 連結
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKLU1K1ol-mP7n2gz7clz522QmjoTAMRfz1lxSKjBwTPMvC5eMimPycZ-RsknpuYkUPaWmHWqj-QNe/pub?output=csv'; 
    // ==========================================

    let dbData = [];       // 存放完整的資料庫資料
    let searchResults = []; // 存放目前的搜尋結果
    let cartList = [];     // 存放今日採集清單

    // 頁面載入完成後執行
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        // 嘗試從 localStorage 讀取舊的清單
        const savedCart = localStorage.getItem('ff14_gathering_cart');
        if (savedCart) {
            cartList = JSON.parse(savedCart);
            renderCart();
        }
    });

    // --- 功能 1: 讀取資料 ---
    function loadData() {
        Papa.parse(SHEET_CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                // 過濾空行並儲存到全域變數
                dbData = results.data.filter(row => row['原料名稱'] && row['原料名稱'].trim() !== '');
                document.getElementById('loadingMsg').style.display = 'none';
            },
            error: function(err) {
                console.error(err);
                document.getElementById('loadingMsg').innerHTML = 
                    `<span class="text-danger">讀取失敗。<br>${err.message}</span>`;
            }
        });
    }

    // --- 功能 2: 搜尋與過濾 (核心更新) ---
    function filterTable() {
        const input = document.getElementById('dbInput').value.trim();
        const resultSection = document.getElementById('searchResultSection');
        const addAllBtn = document.getElementById('addAllBtn');
        const tbody = document.getElementById('tableBody');
        const noMsg = document.getElementById('noResultMsg');
        
        // 1. 若無輸入，隱藏整個結果區
        if (!input) {
            resultSection.style.display = 'none';
            addAllBtn.style.display = 'none';
            searchResults = [];
            return;
        }

        // 2. 顯示結果區並清空舊內容
        resultSection.style.display = 'block';
        tbody.innerHTML = '';
        
        // 3. 解析關鍵字 (支援空白與換行分隔)
        const keywords = input.split(/[\s\n]+/).filter(k => k);
        searchResults = []; // 重置結果陣列

        // 4. 針對每個關鍵字進行搜尋
        keywords.forEach(k => {
            const upperK = k.toUpperCase();
            
            // 在資料庫中尋找符合的項目
            const matches = dbData.filter(row => {
                const name = (row['原料名稱'] || "").trim();
                const mapId = (row['地圖編號'] || "").toUpperCase();
                const note = (row['備註'] || "").toUpperCase();

                // 規則：名稱完全符合 OR 地圖/備註包含
                return name.toUpperCase() === upperK || 
                       mapId.includes(upperK) || 
                       note.includes(upperK);
            });

            if (matches.length > 0) {
                // 如果有找到，加入結果
                // 使用 concat 允許一個關鍵字對應多筆資料 (例如同名但不同地點，或透過地圖搜尋)
                // 這裡我們標記 isNotFound = false
                matches.forEach(m => {
                    // 為了避免 JS 物件參考問題，我們淺拷貝物件
                    searchResults.push({ ...m, isNotFound: false });
                });
            } else {
                // 如果沒找到，建立一個「假」的資料行來顯示
                searchResults.push({
                    '原料名稱': k, // 顯示原本輸入的關鍵字
                    'isNotFound': true // 標記為未找到
                });
            }
        });

        // 5. 渲染搜尋結果
        if (searchResults.length === 0) {
            noMsg.style.display = 'block'; // 理論上不該發生，除非 keywords 為空
            addAllBtn.style.display = 'none';
        } else {
            noMsg.style.display = 'none';
            
            // 檢查是否有「有效」的搜尋結果，決定是否顯示「全部加入」按鈕
            const hasValidResults = searchResults.some(r => !r.isNotFound);
            addAllBtn.style.display = hasValidResults ? 'inline-block' : 'none';
            
            searchResults.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                if (row.isNotFound) {
                    // --- 渲染「無資料」的行 ---
                    tr.classList.add('row-not-found');
                    tr.innerHTML = `
                        <td><button class="btn btn-sm btn-secondary disabled" disabled><i class="bi bi-x-lg"></i></button></td>
                        <td>-</td>
                        <td class="fw-bold text-muted">${row['原料名稱']}</td>
                        <td colspan="3" class="text-start">
                            <i class="bi bi-exclamation-circle"></i> 資料庫查無此資料
                        </td>
                    `;
                } else {
                    // --- 渲染「有資料」的行 ---
                    let imgDisplay = '<span class="text-muted">-</span>';
                    let link = row['圖片連結'] ? row['圖片連結'].replace(/'/g, "").trim() : "";
                    if(link.startsWith('http')) {
                        imgDisplay = `<img src="${link}" class="item-img" alt="圖">`;
                    }

                    tr.innerHTML = `
                        <td>
                            <button class="btn btn-sm btn-success rounded-circle" onclick="addToCartByRowIndex(${index})" title="加入清單">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </td>
                        <td>${imgDisplay}</td>
                        <td class="fw-bold text-primary">${row['原料名稱']}</td>
                        <td>${row['地圖編號'] || ''}</td>
                        <td>${row['採集地點'] || ''}</td>
                        <td><small class="text-muted">${row['備註'] || ''}</small></td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }
    }

    // --- 功能 3: 購物車/清單管理 ---
    
    // 將當前搜尋結果的第 index 筆加入清單
    function addToCartByRowIndex(index) {
        const item = searchResults[index];
        if (item && !item.isNotFound) {
            addToCart(item);
        }
    }

    // 將搜尋結果「全部」加入
    function addAllSearchResults() {
        if(searchResults.length === 0) return;
        
        // 只加入有找到資料的項目
        searchResults.forEach(item => {
            if (!item.isNotFound) {
                addToCart(item, false); // false 代表先不渲染
            }
        });
        renderCart(); // 最後一次渲染
    }

    // 核心加入邏輯
    function addToCart(item, autoRender = true) {
        // 檢查是否已在清單中
        const exists = cartList.find(c => c['原料名稱'] === item['原料名稱']);
        if (!exists) {
            cartList.push({
                ...item,
                cartId: Date.now() + Math.random(), // 唯一 ID
                count: 1,      // 預設數量
                checked: false // 預設未完成
            });
        }
        if (autoRender) renderCart();
    }

    // 渲染清單
    function renderCart() {
        const tbody = document.getElementById('cartBody');
        tbody.innerHTML = '';

        if (cartList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">清單目前是空的，請從上方搜尋並加入項目。</td></tr>';
            saveCart();
            return;
        }

        // 排序：依照地圖編號 (Map ID) 升冪
        cartList.sort((a, b) => {
            const mapA = (a['地圖編號'] || "").toString();
            const mapB = (b['地圖編號'] || "").toString();
            return mapA.localeCompare(mapB);
        });

        cartList.forEach((item, index) => {
            const tr = document.createElement('tr');
            // 根據是否 checked 加上樣式
            if (item.checked) tr.classList.add('row-checked');

            tr.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="form-check-input" style="transform: scale(1.3);" 
                        ${item.checked ? 'checked' : ''} 
                        onchange="toggleCheck(${index})">
                </td>
                <td class="fw-bold">${item['原料名稱']}</td>
                <td><span class="badge bg-secondary text-wrap">${item['地圖編號'] || '未知'}</span></td>
                <td>
                    <div>${item['採集地點'] || '-'}</div>
                    <small class="text-muted">${item['備註'] || ''}</small>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" value="${item.count}" min="1" 
                        onchange="updateCount(${index}, this.value)">
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFromCart(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        saveCart();
    }

    // 切換完成狀態
    function toggleCheck(index) {
        cartList[index].checked = !cartList[index].checked;
        renderCart();
    }

    // 更新數量
    function updateCount(index, val) {
        cartList[index].count = val;
        saveCart(); // 只儲存不需重新渲染
    }

    // 刪除單項
    function deleteFromCart(index) {
        cartList.splice(index, 1);
        renderCart();
    }

    // 清空清單
    function clearCart() {
        if(confirm('確定要清空所有清單嗎？')) {
            cartList = [];
            renderCart();
        }
    }

    // 儲存到 LocalStorage (防止重新整理後消失)
    function saveCart() {
        localStorage.setItem('ff14_gathering_cart', JSON.stringify(cartList));
    }

    // --- 功能 4: Wiki 搜尋 ---
    function searchWiki() {
        const query = document.getElementById('wikiInput').value;
        if (query) {
            const url = `https://www.google.com/search?q=site%3Aff14.huijiwiki.com+${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        }
    }
    // 綁定 Enter 鍵
    document.getElementById('wikiInput').addEventListener("keypress", function(event) {
        if (event.key === "Enter") searchWiki();
    });

</script>

</body>
</html>
