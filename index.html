<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 採集原料資料庫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f4f9; padding-top: 20px; padding-bottom: 50px; }
        .wiki-search-box { background: #e2e3e5; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .item-img { max-width: 50px; max-height: 50px; border-radius: 4px; object-fit: contain;}
        .loading { text-align: center; color: #666; font-style: italic; }
        h1 { color: #333; font-weight: bold; }
        #dbInput { border: 2px solid #0d6efd; background-color: #fff; }
        
        /* 新增按鈕樣式 */
        .btn-add-data {
            background-color: #198754; 
            color: white;
            font-weight: bold;
            margin-top: 10px;
        }
        .btn-add-data:hover { background-color: #146c43; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h1>FF14 採集原料資料庫</h1>
        <p class="text-muted">即時查詢採集地點與資訊</p>
    </div>

    <div class="wiki-search-box">
        <h5><i class="bi bi-search"></i> 搜尋 FF14 灰機 Wiki</h5>
        <div class="input-group">
            <input type="text" id="wikiInput" class="form-control" placeholder="輸入關鍵字 (例如: 鐵礦)...">
            <button class="btn btn-dark" onclick="searchWiki()">搜尋 Wiki</button>
        </div>
        <small class="text-muted">這將會開啟新分頁並透過 Google 搜尋 ff14.huijiwiki.com 站內資料</small>
    </div>

    <hr>

    <div class="mb-3">
        <label for="dbInput" class="form-label fw-bold text-primary">
            <i class="bi bi-funnel-fill"></i> 批量搜尋原料 (只顯示符合的項目)：
        </label>
        <textarea id="dbInput" class="form-control" rows="2" 
            placeholder="在此輸入多個關鍵字，請用「空白」或「逗號」分隔。&#10;例如：鐵礦 靈銀礦 雲母" 
            onkeyup="filterTable()"></textarea>
        
        <div class="d-flex justify-content-between align-items-start mt-2">
            <small class="text-muted">支援同時搜尋多個物品，只要符合任一關鍵字即會顯示。</small>
            <button class="btn btn-add-data btn-sm" data-bs-toggle="modal" data-bs-target="#addDataModal">
                <i class="bi bi-plus-circle-fill"></i> 找不到資料？新增一筆
            </button>
        </div>
    </div>

    <div class="table-responsive bg-white shadow-sm p-3 rounded">
        <div id="loadingMsg" class="loading">正在從 Google Sheets 讀取資料...</div>
        <table class="table table-hover align-middle d-none" id="dataTable">
            <thead class="table-primary">
                <tr>
                    <th>圖片</th>
                    <th>原料名稱</th>
                    <th>地圖編號</th>
                    <th>採集地點</th>
                    <th>備註</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addDataModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 新增原料至資料庫</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addDataForm">
            <div class="mb-3">
                <label class="form-label">原料名稱 <span class="text-danger">*</span></label>
                <input type="text" name="itemName" class="form-control" required placeholder="例如：靈銀礦">
            </div>
            <div class="mb-3">
                <label class="form-label">地圖編號</label>
                <input type="text" name="mapId" class="form-control" placeholder="例如：Lakeland">
            </div>
            <div class="mb-3">
                <label class="form-label">採集地點 (座標)</label>
                <input type="text" name="locName" class="form-control" placeholder="例如：X:10 Y:20">
            </div>
            <div class="mb-3">
                <label class="form-label">圖片連結 (選填)</label>
                <input type="url" name="imgUrl" class="form-control" placeholder="https://...">
            </div>
            <div class="mb-3">
                <label class="form-label">備註</label>
                <textarea name="note" class="form-control" rows="2" placeholder="採集時間、特殊條件等"></textarea>
            </div>
            <div class="d-grid">
                <button type="submit" id="submitBtn" class="btn btn-success">送出資料</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    // configuration
    // ==========================================
    // 1. 讀取用的 CSV 連結 (原有的)
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKLU1K1ol-mP7n2gz7clz522QmjoTAMRfz1lxSKjBwTPMvC5eMimPycZ-RsknpuYkUPaWmHWqj-QNe/pub?output=csv'; 
    
    // 2. 寫入用的 GAS 應用程式網址 (請填入第一步部署後產生的網址)
    const GAS_EXEC_URL = 'https://script.google.com/macros/s/AKfycbziOLUwDDdfrMO5Ye5We3T0gWKM77VHyKWnjFOWkpBCetqNticJ8lw1vGUctoBkyLdATQ/exec'; 
    // ==========================================

    // 1. 頁面載入時執行
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
    });

    // 2. 讀取 Google Sheet 資料
    function loadData() {
        Papa.parse(SHEET_CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                renderTable(results.data);
                document.getElementById('loadingMsg').style.display = 'none';
                document.getElementById('dataTable').classList.remove('d-none');
            },
            error: function(err) {
                document.getElementById('loadingMsg').innerText = "讀取失敗，請檢查 CSV 連結是否正確。";
            }
        });
    }

    // 3. 渲染表格
    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; 

        data.forEach(row => {
            if(!row['原料名稱']) return; 

            const tr = document.createElement('tr');
            
            // 處理圖片壞圖或無圖片的情況
            const imgHtml = row['圖片連結'] 
                ? `<img src="${row['圖片連結']}" class="item-img" onerror="this.style.display='none'">` 
                : '<span class="text-muted">-</span>';

            tr.innerHTML = `
                <td>${imgHtml}</td>
                <td class="fw-bold text-primary">${row['原料名稱']}</td>
                <td>${row['地圖編號'] || ''}</td>
                <td>${row['採集地點'] || ''}</td>
                <td><small>${row['備註'] || ''}</small></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 4. 資料庫內篩選功能
    function filterTable() {
        const input = document.getElementById('dbInput');
        const filterValue = input.value.toUpperCase().trim();
        const table = document.getElementById('dataTable');
        const tr = table.getElementsByTagName('tr');

        if (filterValue === "") {
            for (let i = 1; i < tr.length; i++) tr[i].style.display = "";
            return;
        }

        const keywords = filterValue.split(/[\s,，、\n]+/).filter(k => k.length > 0);

        for (let i = 1; i < tr.length; i++) {
            const tds = tr[i].getElementsByTagName('td');
            const nameText = (tds[1].textContent || tds[1].innerText).trim().toUpperCase();
            const mapText = (tds[2].textContent || tds[2].innerText).toUpperCase();
            const locText = (tds[3].textContent || tds[3].innerText).toUpperCase();
            const noteText = (tds[4].textContent || tds[4].innerText).toUpperCase();

            let isMatch = false;
            for (let j = 0; j < keywords.length; j++) {
                const k = keywords[j];
                // 原料名稱精確比對，其他模糊比對
                if (nameText === k || mapText.indexOf(k) > -1 || locText.indexOf(k) > -1 || noteText.indexOf(k) > -1) {
                    isMatch = true;
                    break;
                }
            }
            tr[i].style.display = isMatch ? "" : "none";
        }
    }

    // 5. 灰機 Wiki 搜尋功能
    function searchWiki() {
        const query = document.getElementById('wikiInput').value;
        if (query) {
            const url = `https://www.google.com/search?q=site%3Aff14.huijiwiki.com+${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        } else {
            alert("請輸入要搜尋的關鍵字");
        }
    }

    // 6. 處理新增資料表單 (發送到 GAS)
    const form = document.getElementById('addDataForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (GAS_EXEC_URL.includes("https://script.google.com/macros/s/AKfycbziOLUwDDdfrMO5Ye5We3T0gWKM77VHyKWnjFOWkpBCetqNticJ8lw1vGUctoBkyLdATQ/exec")) {
            alert("錯誤：請先在程式碼中設定正確的 GAS 部署網址！");
            return;
        }

        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "傳送中...";

        // 使用 fetch 發送資料
        const formData = new FormData(form);
        
        fetch(GAS_EXEC_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors' // 重要：Google Script 跨域需要設為 no-cors (雖然無法讀取回傳值，但能成功發送)
        })
        .then(() => {
            alert("資料已送出！請等待約 1-5 分鐘後重新整理頁面即可看到更新 (Google Sheet 快取延遲)。");
            form.reset();
            // 關閉 Modal
            const modalEl = document.getElementById('addDataModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        })
        .catch(err => {
            console.error('Error:', err);
            alert("發送失敗，請檢查網路或腳本設定。");
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = originalText;
        });
    });
    
    // Enter 鍵觸發 wiki 搜尋
    document.getElementById('wikiInput').addEventListener("keypress", function(event) {
        if (event.key === "Enter") searchWiki();
    });
</script>

</body>
</html>
